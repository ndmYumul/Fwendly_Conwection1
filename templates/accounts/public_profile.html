{% extends 'base.html' %}
{% block content %}
<div class="card shadow-sm text-center">
  <div class="card-body" style="background-color: {{ profile.theme_color }}">
    {% if profile.cover_photo %}
      <img src="{{ profile.cover_photo.url }}" class="img-fluid mb-3" style="max-height:220px; object-fit:cover; width:100%;">
    {% endif %}
    {% if profile.profile_pic %}
      <img src="{{ profile.profile_pic.url }}" class="rounded-circle mb-2 profile-pic">
    {% endif %}
    <h3>{{ profile.user.username }}</h3>
    {% if profile.status_message %}<p><em>"{{ profile.status_message }}"</em></p>{% endif %}
    {% if request.user != profile.user %}
      <a class="btn btn-sm btn-primary" href="{% url 'accounts:send_friend_request' profile.user.id %}">+ Add Friend</a>
    {% endif %}
  </div>
</div>

<div class="row mt-3">
  <div class="col"><strong>üëÄ</strong> {{ profile.profile_views }}<br>Views</div>
  <div class="col"><strong>ü§ù</strong> {{ profile.user.sent_requests.filter(accepted=True).count|add:profile.user.received_requests.filter(accepted=True).count }}<br>Friends</div>
  <div class="col"><strong>üí¨</strong> {{ profile.testimonials.count }}<br>Testimonials</div>
</div>

{% if mutual_interests %}
  <h5 class="mt-3">Mutual Interests</h5>
  <p>{% for tag in mutual_interests %}<span class="badge bg-secondary me-1">{{ tag }}</span>{% endfor %}</p>
{% endif %}

{% if request.user != profile.user %}
  <h5 class="mt-3">Mutual Friends ({{ mutual_friends.count }})</h5>
  <ul class="list-group mb-3">
    {% for mf in mutual_friends %}
      <li class="list-group-item"><a href="{% url 'accounts:profile' mf.username %}">{{ mf.username }}</a></li>
    {% empty %}<li class="list-group-item">No mutual friends.</li>{% endfor %}
  </ul>
{% endif %}

<h4 class="mt-3">About</h4>
{% if can_see_profile %}
  <p><strong>Location</strong>: {{ profile.location|default:"‚Äî" }}</p>
  <p><strong>Interests</strong>: {{ profile.interests|default:"‚Äî" }}</p>
  <p>{{ profile.bio|default:"No bio yet." }}</p>
{% else %}
  <p class="text-muted">This profile is private.</p>
{% endif %}

<h4 class="mt-3">Testimonials</h4>
{% if can_see_testimonials %}
  {% if request.user != profile.user %}
    <form method="post" action="{% url 'accounts:add_testimonial' profile.user.username %}" class="mb-2">{% csrf_token %}
      <div class="input-group">
        <input name="content" class="form-control" placeholder="Write on their wall">
        <button class="btn btn-primary">Post</button>
      </div>
    </form>
  {% endif %}

  <div class="list-group">
    {% for t in testimonials %}
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div><strong>{{ t.author.username }}</strong> <span class="text-muted">({{ t.created_at|date:"M d, Y" }})</span><p class="mb-0">{{ t.content }}</p></div>
        {% if request.user == profile.user %}
          <div>
            {% if t.is_hidden %}
              <span class="badge bg-secondary me-2">Hidden</span>
              <form method="post" action="{% url 'accounts:unhide_testimonial' t.id %}" style="display:inline;">{% csrf_token %}
                <button class="btn btn-success btn-sm">Unhide</button>
              </form>
            {% else %}
              <form method="post" action="{% url 'accounts:hide_testimonial' t.id %}" style="display:inline;">{% csrf_token %}
                <button class="btn btn-warning btn-sm">Hide</button>
              </form>
            {% endif %}
            <form method="post" action="{% url 'accounts:delete_testimonial' t.id %}" style="display:inline;">{% csrf_token %}
              <button class="btn btn-danger btn-sm">Delete</button>
            </form>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p class="text-muted">No testimonials yet.</p>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">Testimonials are private.</p>
{% endif %}

<h4 class="mt-3">Gallery</h4>
{% if can_see_gallery %}
  <div class="row">
    {% for img in profile.gallery.all %}
      <div class="col-md-3 mb-3">
        <img src="{{ img.image.url }}" class="img-fluid" style="height:160px; object-fit:cover; width:100%;">
        <small class="text-muted d-block">{% if img.album %}Album: {{ img.album.name }}{% else %}No album{% endif %}</small>
      </div>
    {% empty %}
      <p class="text-muted">No images yet.</p>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">Gallery is private.</p>
{% endif %}

<h4 class="mt-3">Top 5</h4>
<div class="row">
  {% for tf in profile.topfives.all %}
    <div class="col-md-6 mb-3">
      <div class="card"><div class="card-body">
        <h6 class="card-title">{{ tf.title }}</h6>
        <ol class="mb-0">{% for item in tf.list_items %}<li>{{ item }}</li>{% endfor %}</ol>
      </div></div>
    </div>
  {% empty %}
    <p class="text-muted">No Top 5 yet.</p>
  {% endfor %}
</div>

{% if profile.music %}
  <div class="mt-3">
    <audio {% if profile.music_autoplay %}autoplay muted{% endif %} controls>
      <source src="{{ profile.music.url }}" type="audio/mpeg">
    </audio>
  </div>
{% endif %}

{% endblock %}
